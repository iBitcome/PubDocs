# IOS应用软件通用安全设计

# 编译保护

IOS应用程序（IPA）可以采用Objective-C、C++、RubyMotion等语言编写而成。IPA文件是IOS系统设备上的.app文件的最终形式，它的组成是由资源文件、本地化文件、plist 文件以及app文件组成。其中前三者可以通过解压缩IPA或从安装在IOS上后的相应位置可以得到。

根据客户端应用程序IPA的特性，App文件进行反编译后，汇编语言中可以查看到函数名称、代码逻辑等信息，通过修改后的IPA也可以进行伪签名后发布。

# 数据存储安全

不安全的数据存储（Insecure Data Storage）位列OWASP TOP 10 Mobile Risks之首。在移动互联网时代，个人信息安全极大的依赖移动客户端系统及软件的安全，不安全的数据存储可能导致应用软件敏感信息、用户隐私数据泄露。

数据存储的不安全问题通常由以下原因导致：

* 数据未经加密存储
* 缓存信息没有及时清除
* 不正确的访问控制策略
* 忽略了不同平台的特性

IOS平台易受影响的对象：

* Custom created files,
* Databases,
* System logs,
* Cookie stores,
* Plists,
* Data caches.

1、在软件设计阶段，根据业务功能和需求划分出敏感数据。敏感数据应尽量在服务端进行安全的存储。当然，必须确保网络数据传输的安全性。

2、用户个人的敏感信息必须设置最长的保存时间，一旦超过该时间必须立刻删除。

3、应用程序只能收集或者公开业务和应用必须的用户数据。在设计阶段也必须定义出哪些是必须数据，包括它的敏感度、是否可以被其他程序访问。

4、必须在客户端存储的敏感数据应采用IOS平台提供的加密函数或者权威第三方提供的加密函数，不应该自行开发加密算法或者使用弱加密功能的函数（如Base64），密码、证书等信息可以考虑采用Keychain的方式存储。

# 敏感信息安全

## 硬编码问题

软件中的硬编码问题（Hardcode）会导致应用程序敏感信息泄露。硬编码是一种不灵活的代码实现方案。在程序开发阶段，程序员为了缩短开发周期，方便程序调用等原因，把输入或输出的相关参数（例如：路径、输出的形式、格式、身份认证信息）直接写入源代码中，而非在程序运行时由外界指定的配置、资源或者输出格式做出适当回应。例如应用程序需访问数据库SQLite，本应调用配置文件读取数据库的账号和密码信息，但是程序员直接把账号和密码写入代码中方便调用，就造成了硬编码问题。

IOS应用程序主要使用Objective-C语言开发，可以被反汇编成汇编代码，从而读取硬编码的账号和密码信息。

## SQL注入

IOS应用程序需要在客户端存储一些数据，最简单的方法之一就是利用SQLite数据库。 应用程序可以构造SQL语句，实现对本地数据库的各种操作，方便数据存取。IOS平台的 SQL语句操作与普通WEB平台一样存在SQL注入危险，可能导致应用程序的敏感数据和用户隐私数据泄露。

## 跨站点脚本攻击

UIWebView是IOS系统中的文本解释器，它支持以下几种文件格式：

* HTML
* PDF
* RTF
* Office 文档 (doc, xls, ppt)
* iWork 文档 (Pages, Numbers and Keynote)

WEB视图基于WebKit组件，核心框架与Safari、MobileSafari相同。因此，WEB视图不仅仅具有WEB浏览的功能，而且可以获取并显示远程内容。WEB视图支持JavaScript，允许APP执行客户端的动态脚本。API中并没有选项可以禁用该特性，所以与传统的WEB应用相同，IOS应用程序可能遭受跨站点脚本攻击（Cross-Site Scripting、XSS）。通过执行 JavaScript，可以获取图片、定位信息，发送短信或者电子邮件等。

# 数据传输安全

## 网络数据传输

可移动设备主要的特点在于它能支持多种网络通信机制，例如WIFI，网络供应商（3G、GSM、CDMA），蓝牙等等。网络中的嗅探、监听等行为可以获取传输中所有明文信息，一些弱加密的信息也很容易被解码。

在一个公共的WIFI区域享受上网服务，很容易被监听到用户名、密码以及各种身份信息。所以敏感信息的传输必须经过严格的加密处理，有必要时需通过数字证书的方式验证通信双方的身份信息。

## IPC安全

由于IOS沙盒的强制限制，进程间通信（Inter-Process Communication，IPC）是被禁止的。然而，API中提供了一个简单的形式实现IPC，应用程序只需注册一个自定义的protocol handler。如果protocol handler处理不当，可能被应用程序访问敏感数据，调用特殊功能。

# 异常处理

当软件发生系统故障时，应保证系统能够保存重要数据并正常结束。如果没有正确的异常处理机制，而是直接把异常信息返回给用户，可能会给有经验的攻击者提供软件运行时的蛛丝马迹。

# 日志审计

日志系统可以帮助开发者在应用程序开发过程中获取有用的调试信息，但也有可能泄露 敏感信息。日志存储在缓存中直至系统重启。Objective-C中记录日志信息通常采用NSLog方法，产生一条信息并发送给IOS系统日志。这些控制台日志对Xcode发起的应用程序不可访问，但是任何安装在设备上的应用程序都可以通过调用ASL库来访问。

使用第三方工具iTools中的系统日志查看功能，可以捕获系统日志和应用程序运行日志。攻击者借助该工具可以收集敏感信息。

一些越狱的设备可能导致NSLog的输出直接重定向到syslog，syslog中的敏感信息可能被存储到文件系统中。因此，建议开发人员避免用NSLog记录敏感信息。

# 增强的安全

## 软件更新

应用程序应设计并提供安全更新的功能。发布新版本的安全更新时应提示用户下载。如果采用动态加载更新补丁的方式，需校验补丁程序的签名证书是否合法，防止补丁被替换并植入恶意代码。

## 安全问题反馈接口

应在客户端提供用户的反馈接口，接收用户的各种安全问题和建议。

## 内存污染问题

IOS应用程序可能遭受经典的内存污染问题。例如，如果开发者依靠Objective-C完成内存分配而不是指定固定大小缓冲区，则可能导致缓冲区溢出。C语言可以被混合进IOS应用程序，在C语言的开发中使用扩展库或者执行独立的代码经常可见，比如加密函数。这些条件提高了传统内存污染漏洞的风险。

## 后台处理

IOS应用程序运行状态下可能被推送至后台处理。例如用户按下HOME键，或者来电提示。如果应用程序在后台挂起，IOS系统会在应用程序缓存目录下建立一个当前快照。如果应用程序被推送至后台前开打了任何敏感信息，快照也会以明文形式存储在文件系统中。

# 合规性安全功能

合规性安全功能是为了满足合规性安全需求，目前暂无。

# 业务安全功能

除以上通用的IOS通用软件安全设计之外，不同的应用软件一般要求结合自身的业务，提供一定的业务安全功能。例如，部分网银客户端需要应用软件记录登录客户端的MAC地址，该地址需由客户端程序读取。




