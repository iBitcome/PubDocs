# Android应用软件通用安全设计

# 源代码保护

Android应用软件可以采用Html5、JAVA、C语言等编写而成，其中绝大部分项目都是采用JAVA开发的。


根据JAVA语言的特性，即使编译之后的Classes字节码也很容易被反编译工具轻松转换为JAVA的源代码，导致程序可以轻易的被读取和分析。需要对程序代码进行混淆保护以对抗这种攻击行为。


源代码需要通过以下的方式进行保护：

* 源代码混淆：

不改变代码逻辑的情况下，增加无用代码，或者重命名类名、方法名和变量名，使反编译后的源代码难于看懂，提高被识别的难度。Android SDK中自带了基于Java的代码混淆器ProGuard，使用它可以轻松的实现源代码混淆。ProGuard默认会对Class文件中所有的类、方法以及字段进行混淆。

* NDK保护：

Android NDK（Native Development Kit）是一组支持开发者使用C/C++源文件编译并嵌入Android应用程序的工具。使用C/C++实现对应用程序关键函数的代码编写，可以加大应用软件被逆向分析的难度。

* 程序自校验：

Android系统通过应用程序的签名来追踪代码作者、判断程序是否被修改以及建立程序之间的关系。如果两个程序用不同的证书来签名，则两个程序互为不信任状态，无法共享数据。如果两个程序用相同的证书来签名不仅可以设置共享私有数据还可以运行于同一段内存空间。
1)	将证书进行Base64编码，并将编码后的字符串保存在程序中；
2)	将证书签名（MD5或SHA1值）进行对称算法加密（比如：DES），然后将加密后的结果和对称算法密钥放在一起，再使用证书的privatekey对其加密，将加密后的结果保存在一个.conf文件中；
3)	客户端启动时，通过解码(1)中的字符串得到证书的公钥，然后使用公钥解码.conf文件，得到对称算法的key；然后使用key去解码被加密的签名字符串；
4)	客户端通过运行时环境，获取到安装包的证书签名，并与配置文件中的比较，相等则为合法签名，否则安装包已经使用了其它非法的证书进行了签名。

# 数据存储安全

不安全的数据存储（Insecure Data Storage）位列OWASP TOP 10 Mobile risks之首。在移动互联网时代，个人信息安全极大的依赖移动客户端系统及软件的安全，不安全的数据存储可能导致应用软件敏感信息、用户隐私数据泄露。

数据存储的不安全问题通常由以下原因导致：

* 数据未经加密存储
* 缓存信息没有及时清除
* 不正确的访问控制策略
* 忽略了不同平台的特性

Android平台易受影响的对象：

* SQLite databases
* Log Files
* Plist Files
* XML Data Storesor ManifestFiles
* Binarydata stores
* Cookie stores
* SD Card
* Cloud synced

1、在软件设计阶段，根据业务功能和需求划分出敏感数据。敏感数据应尽量在服务端进行安全的存储。当然，必须确保网络数据传输的安全性。  
2、必须在客户端存储的敏感数据应采用Android平台提供的加密函数或者权威第三方提供的加密函数，不应该自行开发加密算法或者使用弱加密功能的函数（如Base64）。  
3、敏感数据的存储应尽量放在私有文件区域，如SQLite数据库，应用程序的私有目录（一般是/data/data/<包名>/）。避免存放在公共区域，如SD Card中。使用openFileOutput()方法创建文件时，注意文件读写权限，见下表。  
|           模式值            |         描述       |
|           -----            |        -----      |
|Context.MODE_PRIVATE        | 默认操作,表示只有创建文件的程序对该目标可读可写 |
|Context.MODE_APPEND         | 检查文件是否存在，如果存在就追加数据，否则就创建新文件 |
|Context.MODE_WORLD_READABLE | 全局读,除了创建文件的程序对该目标可读可写之外,其它程序可以对该文件进行读操作 |
|Context.MODE_WORLD_WRITEABLE| 全局写,除了创建文件的程序对该目标可读可写之外,其它程序可以对该文件进行写操作 |

   - 将用户隐私数据加密保存在内部存储设备区域。
   - 将软件配置文件、备份及辅助数据保存在内部存储区域
   - 将软件安装包和可执行代码保存着内部存储区域。
   - 应及时删除应用程序不需要的敏感信息。
   - 用户个人的敏感信息必须设置最长的保存时间，一旦超过该时间必须立刻删除。
   - 应用程序只能收集或者公开业务和应用必须的用户数据。在设计阶段也必须定义出哪些是必须数据，包括它的敏感度、是否可以被其他程序访问。

# 敏感信息安全

## 运行时日志信息

Android软件运行时会输出运行时日志。开发者在程序设计过程中为了方便了解程序运行情况也经常实时向Android日志系统输出日志。如果软件开发过程中日志输出功能设计失误，很可能会泄露用户和系统的敏感信息。

Android系统自带Logcat工具，可以捕获系统日志和应用程序运行日志。攻击者借助该工具可以收集敏感信息。

与数据存储安全相似，敏感信息的安全处理首先需要在设计阶段划分出敏感信息。程序编码阶段，在进行日志输出、程序调试输出的环节，需严格控制敏感信息的输出。

## 	硬编码问题

软件中的硬编码问题（Hardcode）会导致应用程序敏感信息泄露。硬编码是一种不灵活的代码实现方案。在程序开发阶段，程序员为了缩短开发周期，方便程序调用等原因，把输入或输出的相关参数（例如：路径、输出的形式、格式、身份认证信息）直接写入源代码中，而非在程序运行时由外界指定的配置、资源或者输出格式做出适当回应。例如应用程序需访问数据库SQLite，本应调用配置文件读取数据库的账号和密码信息，但是程序员直接

把账号和密码写入代码中方便调用，就造成了硬编码问题，如下代码所示：

```

public class HttpUtil{
	public static final String USER_NAME = "username";
    
    public static final String USER_PWD = "password";
	
    // do something

}

```


JAVA语言的特性使其很容易被反编译成可读文件，其硬编码的问题尤其严重。即使编译成库文件，也很容易通过IDA调试出硬编码信息。

数据库链接字符串、用户名密码等不宜在程序中写死，而应采用配置文件来存储。XML是自描述的、通用的文件结构，能够很好的解决硬编码问题，软化代码。JAVA语言设计了getString()等方法从资源文件读取String字符串。配置文件的安全应参考数据存储安全进行设计。

## SQL注入

Android系统提供一个轻量级数据库系统SQLite。应用程序可以构造SQL语句，实现对本地数据库的各种操作，方便数据存取。Android平台的SQL语句操作与普通WEB平台一样存在SQL注入危险，可能导致应用程序的敏感数据和用户隐私数据泄露。

Android应用程序SQL注入问题的解决思路与其他应用程序相同。以参数化查询的方式替代字符串拼接，可以有效的解决该问题。

# 数据传输安全

## 网络数据传输

可移动设备主要的特点在于它能支持多种网络通信机制，例如WIFI，网络供应商（3G、GSM、CDMA），蓝牙等等。网络中的嗅探、监听等行为可以获取传输中所有明文信息，一些弱加密的信息也很容易被解码。

在一个公共的WIFI区域享受上网服务，很容易被监听到用户名、密码以及各种身份信息。所以敏感信息的传输必须经过严格的加密处理，有必要时需通过数字证书的方式验证通信双方的身份信息。

采用端到端的加密手段保护通信过程中数据传输的安全。在Android平台上经常采用HTTPS的方式进行服务端和客户端的数据交互。加密的数据包括身份鉴别信息，银行卡账户密码等敏感信息。Android实现HTTPS有两种方式，一种不验证服务端证书，另一种需验证服务端证书。后者可以有效的预防钓鱼、中间人攻击等。

针对加密协议的安全规则：

* 客户端与服务器之间所有经过认证的连接都需要使用不低于TLS安全级别的加密通讯方式
* 使用TLS协议时，其版本应1.2及更高以上版本
* 使用TLS协议时，应取消对低版本TLS协议的支持

针对安全认证过程的安全规则：

* 在通信双方建立连接之前，应利用密码技术进行会话初始化验证
* 应对通信过程中的整个报文或会话过程进行加密，例如采用HTTPS方式
* 系统应进行完整性校验，如SHA256。完整性校验码密钥长度不低于256位
* 使用TLS协议时，TLS加密密钥长度不应低于256位
* 使用TLS协议时，用于产生签名的RSA密钥长度不应低于2048位
* 使用TLS协议时，确保TLS证书使用正确的domain name
* 使用TLS协议时，确保TLS证书时间没有过期

## 组件通信安全

组件通信安全是指客户端应用程序之间的通信，组件与组件之间的通信，所引发的安全问题。Android应用程序中的4大组件（Activity、Service、Content Provider、Broadcast Receiver）依靠组件间通信传递数据信息，数据的传递依靠Internet来完成。


# 异常处理

当软件发生系统故障时，应保证系统能够保存重要数据并正常结束。如果没有正确的异常处理机制，而是直接把异常信息返回给用户，可能会给有经验的攻击者提供软件运行时的蛛丝马迹。

# 日志审计

Android客户端应用软件日志主要为记录软件运行时的异常事件。在Android客户端程序发开中经常需要记录程序执行过程的机制，既可以用于程序调试，也方便程序运行中的事件记录。

Android系统中提供了一个轻量级的日志系统，这个日志系统以驱动程序的形式实现在内核空间中。在用户空间分别提供了JAVA接口和C/C++接口供开发者使用日志系统。C/C++日志接口一般是在编写硬件抽象层模块或者编写JNI方法时使用，而JAVA接口一般是在应用层编写软件时使用。

Android应用程序一般是调用应用程序框架层的JAVA接口（android.util.Log）来使用日志系统，这个JAVA接口通过JNI方法和系统运行库最终调用内核驱动程序Logger把Log写到内核空间中。Logcat是Android系统自带的日志查看工具，内置在Android系统中。在用户空间中可以调用adblogcat命令查看所有日志信息。

为方便调试软件，并保证业务层的软件运行安全，可以把运行日志输出到本地文件中进行保存，应注意以下几点。

* 使用时间戳必须明确的把时间戳包含在日志文件内，时间戳可以形成一条清晰的事件时间线。
* 记录每个重要行为确保在某种重要行为发生时有相应的记录，捕获系统异常信息。
* 保护日志文件控制其他应用程序对日志的访问权限。

# 增强的安全

## APP权限最小化

Android程序本身可以在安装时被授予很多权限和功能，如发送短信，手机定位，访问其他应用程序等，这些权限和功能在特定环境下可能被恶意代码所利用。根据软件设计的基本原则“最小特权原则”，在设计应用程序的功能和权限时，只赋予完成操作的必备权限和最少功能。

## 软件更新

应用程序应设计并提供安全更新的功能。发布新版本的安全更新时应提示用户下载。如果采用动态加载更新补丁的方式，需校验补丁程序的签名证书是否合法，防止补丁被替换并植入恶意代码。

## 安全问题反馈接口

应在客户端提供用户的反馈接口，接收用户的各种安全问题和建议。

## 第三方组件安全

用户可能在不知情的情况下安装了恶意软件或者灰色软件。这些恶意软件可能利用应用程序漏洞获取用户的隐私信息和应用程序信息。

* 开发过程中如果调用第三方代码或库文件，应确保其来源的可靠性
* 跟踪应用软件中所有第三方框架和API，所有第三方框架和API必须完成安全更新
* 特别注意未经验证的第三方的数据接收和发送（例如网络传输）

## 浏览器跨域问题

如果是基于Android系统Webkit浏览器内核开发的应用程序，或者其他形式的浏览器，可能存在浏览器跨域问题。WebView这个组件可以解析HTML和Javascript等代码，可能导致恶意脚本执行。

如果WebView组件中不需要使用JavaScript，不要调用setJavaScriptEnabled()方法。WebView默认不会执行JavaScript。如果需执行JavaScript代码，请严格检查输入的参数的是否合法。
addJavaScriptInterface()方法可以允许JavaScript访问应用程序中的对象，所以该方法只能开放给信任的组件。

## 软键盘保护

为了保证用户输入的保密性，应该提供应用程序自主开发的软键盘功能，而不调用系统默认软键盘。

# 合规性

合规性安全功能是为了满足合规性安全需求，目前暂无。

# 业务安全

除以上通用的Android通用软件安全之外，不同的应用软件一般要求结合自身的业务提供一定的业务安全功能。例如，部分网银客户端需要应用软件记录登录客户端的MAC地址，该地址需由客户端程序读取。




   



