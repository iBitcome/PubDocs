# 数字钱包安全审计

## 目录

* [前言](#前言)
* [一、钱包安全现状](#一、钱包安全现状)
* [二、钱包安全审计项](#二、钱包安全审计项)
  * [钱包客户端app安全审计](#钱包客户端app安全审计)
    * [运行环境安全检测](#运行环境安全检测)
      * [Root/越狱环境检测](#Root/越狱环境检测)
      * [模拟器环境检测](#模拟器环境检测)
      * [APP完整性检测](#APP完整性检测)
      * [网络代理检测](#网络代理检测)
      * [网络安全检测](#网络安全检测)
    * [协议交互安全检测](#协议交互安全检测)
      * [新用户注册安全检测](#新用户注册安全检测)
      * [创建交易安全检测](#创建交易安全检测)
      * [交易签名安全检测](#交易签名安全检测)
      * [交易完毕确认检测](#交易完毕确认检测)
      * [余额查询安全检测](#余额查询安全检测)
    * [数据存储安全检测](#数据存储安全检测)
      * [助记词创建安全检测](#助记词创建安全检测)
      * [助记词存储安全检测](#助记词存储安全检测)
      * [私钥生成安全检测](#私钥生成安全检测)
      * [私钥存储安全检测](#私钥存储安全检测)
      * [授权口令存储安全检测](#授权口令存储安全检测)
      * [keystore文件创建安全检测](#keystore文件创建安全检测)
      * [keystore文件存储安全检测](#keystore文件存储安全检测)
      * [PIN码创建安全检测](#PIN码创建安全检测)
      * [PIN码存储安全检测](#PIN码存储安全检测)
      * [本地存储数据敏感性检测](#本地存储数据敏感性检测)
    * [功能设计安全检测](#功能设计安全检测)
      * [导入钱包功能安全检测](#导入钱包功能安全检测)
      * [交易密码安全检测](#交易密码安全检测)
      * [用户输入安全检测](#用户输入安全检测)
      * [转账地址安全检测](#转账地址安全检测)
      * [助记词，私钥网络储存安全检测](#助记词，私钥网络储存安全检测)
      * [https通信中的证书校验检测](#https通信中的证书校验检测)
  * [钱包服务器端安全审计](#钱包服务器端安全审计)
    * [域名DNS安全检测](#域名DNS安全检测)
      * [域名DNS安全检测](#域名DNS安全检测)
      * [域名记录安全检测](#域名记录安全检测)
      * [DNS服务安全检测](#DNS服务安全检测)
      * [TLD/gTLD安全检测](#TLD/gTLD安全检测)
      * [全网多节点DNS解析监测](#全网多节点DNS解析监测)
      * [证书安全](#证书安全)
    * [主机实例安全检测](#主机实例安全检测)
      * [口令安全](#口令安全)
      * [系统安全](#系统安全)
      * [访问控制](#访问控制)
      * [日志审计](#日志审计)
      * [冗余安全](#冗余安全)
      * [云IAM授权检测](#云IAM授权检测)
    * [服务端应用安全检测](#服务端应用安全检测)
      * [代码安全](#代码安全)
      * [服务应用安全](#服务应用安全)
      * [存储安全](#存储安全)
      * [环境隔离](#环境隔离)
      * [云存储](#云存储)
* [三、总结](#三、总结)
* [四、参考](#四、参考)


## 前言

区块链技术的迅速发展，使得数字货币渐渐走入的大众的视线，在2017年底，这股热潮达到顶峰，直接搅动着金融市场与科技市场，大量的数字货币交易流水催生了数字钱包开发行业，根据钱包使用时的联网状态分为热钱包和冷钱包。

随着各种数字货币的诞生，为了方便用户记录地址和私钥，官方会同时发布全节点钱包，例如Bitcoin Core，Parity钱包，同时也有一些第三方公司为了进一步提高用户体验，他们相继开发了如比特派，imToken，AToken，币信，币包等钱包APP，它们并不同步所有的区块数据，因此称其为轻钱包，这两种数字钱包都属于热钱包。冷钱包也称为硬件钱包，常见的冷钱包有库神钱包，Ledger NanoS，Trezor等，由于私钥不接触网络，相对安全性也较高。不过由于业务场景的快速迭代以及推广需求，无论热钱包还是冷钱包都会有一些的安全隐患会被忽视。

## 一、钱包安全现状



## 二、钱包安全审计项

基于对当前数字钱包APP的安全现状分析，我们将发现的需要审计的安全项进行归纳总结为四个方面：

- 运行环境安全
- 协议交互安全
- 数据存储安全
- 功能设计安全

### 钱包客户端app安全审计

#### 运行环境安全检测

- Root/越狱环境检测

钱包APP未对于手机环境进行root/越狱检测，会导致APP运行在已root/越狱的手机上，使得APP相关核心执行过程被逆向调试分析，通过将app安装在root/越狱后的生机上启动来判定设备是否已被root。
  
- 模拟器环境检测

钱包APP未对于手机环境进行模拟器检测，会导致APP运行在已模拟器的手机上，使得APP相关核心执行过程被逆向调试分析，通过将app安装在模拟器上启动来判定设备是否已被模拟器。

- APP完整性检测

钱包APP未做完整性检测，会导致黑客可以对APP重新打包植入恶意代码，窃取用户助记词，私钥等敏感信息，使用apktool等工具对APP进行重打包，修改验证机制来判定是否可利用此漏洞。

- 网络代理检测

APP在运行中，未检测是否使用相关代理，将会导致协议交互过程中网络数据被黑客监听。使用burpsuite、fiddler等工具确认app是否有代理检测。

- 网络安全检测

钱包APP未检测验证当前使用网络的DNS是否安全，将会会存在被劫持的可能，导致一些网络回传的数据被黑客恶意修改。将通过技术手段模拟黑客攻击，来确认是否安全。

#### 协议交互安全检测

- 新用户注册安全检测

在安装完APP后，新用户需要进行注册，才能使用钱包APP，在这个注册过程中，如将用户敏感信息上传至服务器，会存在很大安全风险，比如传输过程或服务器上被黑客攻击获取注册信息。对网络传输数据进行逆向分析，查看是否存在隐患。

- 创建交易安全检测

在用户创建交易时，交易双方的账号如果没有二次验证，则容易导致收款账户信息被恶意替换后无法知道，导致用户钱财损失问题。使用技术手段进行测试，验证钱包APP是否存在此风险。

- 交易签名安全检测

在交易创建后，发送正式签名交易过程，如果相关协议设计不严格，会导致用户财产受到损失。对交易过程逻辑代码进行逆向分析，查看是否存在相关安全隐患。

- 交易完毕确认检测

交易完毕后，如果未对交易内容进行确认，会导致使用户清晰了解此次交易过程的记录，在APP上无法记录相关信息，无法查询个人交易记录。对此过程进行分析，查看是否存在相关安全隐患。

- 余额查询安全检测

钱包APP在进行余额查询时，无论是从货币官方服务器，还是钱包厂商服务器进行的查询，应严格对其返回给客户端的数据进行完整性验证，否则容意导致用户APP数据接收虚假、异常信息。对此流程进行确认，查看是否存在安全隐患。


#### 数据存储安全检测

- 助记词创建安全检测

新用户使用钱包APP时，会生成助记词要求用户记录，此过程是否有检测截屏，录屏等操作，如未进行安全检测，将会导致钱包核心敏感信息泄露，用户钱财损失。

- 助记词存储安全检测

助记词生成后，如果会在本地保存，在本地保存时是明文存储，将会导致黑客进行攻击获取用户助记词信息。如果是加密存储，加密算法安全性不高，将会导致黑客可以逆向分析算法，将加密数据进行恢复明文，导致用户助记词信息泄露。模拟黑客攻击，检测相关流程是否存在安全隐患。

- 私钥生成安全检测

钱包APP在新用户私钥生成过程，相关算法如果可被逆向分析，会导致黑客模拟生成的私钥，使用户的钱财受到损失。将逆向分析相关算法，确认是否存在此安全隐患。

- 私钥存储安全检测

私钥生成后，如果会在本地保存，在本地保存时是明文存储，将会导致黑客进行攻击获取用户私钥信息。如果是加密存储，加密算法安全性不高，将会导致黑客可以逆向分析算法，将加密数据进行恢复明文，导致用户私钥信息泄露。模拟黑客攻击，检测相关流程是否存在安全隐患。

- 授权口令存储安全检测

用户输入授权口令后，如果会在本地存储，会导致黑客进行攻击获取用户私钥信息。如果是加密存储，加密算法安全性不高，将会导致黑客可以逆向分析算法，将加密数据进行恢复明文，导致用户授权口令泄露。逆袭app分析相关算法，确认是否存在此安全隐患。

- keystore文件创建安全检测

keystore文件创建算法过程是否安全和不可逆，如果不安全将会导致黑客恢复出授权口令和用户私钥。分析keystore文件的创建过程算法是否安全可靠。

- keystore文件创建安全检测

keystore文件如果明文存储在app，将会导致黑客拿到keystore文件进行暴力破解得到授权口令和私钥信息。如果keystore文件存储位置不安全，例如存储到storage区域， 将会导致恶意应用删除keystore导致用户无法正常使用钱包。分析keystore存储流程是否存在此安全隐患。

- PIN码创建安全检测

钱包在创建PIN码是否有检测截屏，录屏等操作，如未进行安全检测，将会导致钱包PIN码信息泄露的风险。

- PIN码存储安全检测

PIN码如果明文存储在app或者是采用错误的加密算法存储在本地，将会导致被黑客获取到PIN。检测PIN码存储是否采用哈希散列和加密存储到方式存储PIN码。

- 本地存储数据敏感性检测

在本地存储数据时，是否会将敏感信息保存在本地，如果一些对用户敏感的信息保存在本地，容易被攻击者进行逆向分析，我们会对其进行逆向分析，查看本地是否存在敏感信息。

#### 功能设计安全检测

- 导入钱包功能安全检测

用户使用导入钱包的功能，是会将之前用户存储在系统中的私钥直接恢复，恢复过程如果被监控，相关功能设计不严格，会导致在此过程被黑客攻击。模拟黑客攻击，进行相关验证。

- 交易密码安全检测

交易密码如果未检测弱口令，将会导致黑客对密码进行猜解，直接进行交易；交易密码日字旁本地存储，本地储存加密不严格，则会导致黑客对其进行逆向分析，获取到交易密码。模拟黑客攻击，验证此安全隐患是否存在。

- 用户输入安全检测

用户输入数据，如果功能设计不严格，将会被黑客监听窃取；如果采用第三方键盘进行，未对用户输入逻辑做校验，容易被黑客监听获取敏感信息，。模拟黑客攻击，查看相关流程是否严格，验证此安全隐患是否存在。

- 转账地址安全检测

钱包APP在输入转账地址或扫描二维码转账地址后，如果未检测地址被篡改，保证转账地址完整，会导致用户钱财受到损失。模拟黑客攻击，查看相关流程是否存在安全隐患。

- 助记词，私钥网络储存安全检测

助记词和私钥应当禁止通过网络传输回APP厂商，防止服务器被攻击用户数据与钱财被盗取，如果有相关回传数据操作，容易导致用户数据与钱财被盗。逆向分析相关网络协议，查看是否存在相关安全隐患。

- https通信中的证书校验检测

在数据网络交互通信中，如果使用https，未对证书做严格的校验，将会导致中间人劫持攻击，黑客将数据替换，导致用户在APP上收到虚假信息。模拟黑客攻击，对此过程进行验证，确认是否存在相关安全隐患。

### 钱包服务器端安全审计

服务端作为区块链数字钱包的中心化对象，显然已是黑客十分青睐的攻击目标，安全是其健壮运行的核心基石。基于对当前数字钱包服务端的安全现状分析，将相关审计点进行归纳总结，并提供相关安全建议。

- 域名DNS安全检测
- 主机实例安全检测
- 服务端应用安全检测

#### 域名DNS安全检测

- 域名注册商安全检测评估

对数字钱包所用域名注册商，需进行评估，防止钱包域名被恶意社工篡改和攻击。建议使用国内外排名靠前的域名注册商。

- 域名记录安全检测

对数字钱包接口所用域名及其解析记录，增改进行审核，并定期复查，防止被CNAME/NS/SOA劫持，做好权限管理和日志收集。数字钱包使用云CDN时，合理配置相关参数，避免子域劫持，域名前置，Web缓存欺骗等安全问题，同时选用业界安全性较好的CDN服务提供商。

- DNS服务安全检测

域名解析服务，钱包厂商自建的，做好上线前的审计和运行后的定期复查。使用第三方DNS解析服务的，建议一定要选用国内外大厂商，预防域名解析被恶意社工或利用漏洞篡改，或拒绝服务攻击。合理配置DNS配置参数，预防伪造邮件,证书校验,DNSSEC,高纬度攻击BGP等安全问题。

- TLD/gTLD安全检测

建议使用org等顶级域名，不要选用小众后缀域名，防止被恶意篡改和劫持上层记录。如2017年6月，Matthew劫持io顶级域.

- 全网多节点DNS解析监测

选用排名靠前的第三方服务，使用全球不同节点对DNS记录进行解析，监控解析结果是否正常，是否被污染篡改等。如遇大面积故障，协调多方及时应急响应。

- 证书安全

数字钱包内置证书时，选用20年等时间较长的证书，避免APP升级迭代后的兼容问题。同时建议选择国内外知名证书机构签发的证书，避免信任链牵连问题。
  
#### 主机实例安全检测

- 口令安全

审计数字钱包所用服务口令强度，建议设置为强密码，SSH类使用证书登陆，最好前置堡垒机。

- 系统安全

数字钱包服务端系统，高危漏洞及时更新，系统和内核等加固配置，减轻未知的漏洞，预防被攻击后的提权和横向渗透等操作。

- 访问控制

数字钱包服务端在云上时，云安全组ACL是其第一道防线，严格限制出入站端口和ip的开放，避免高危和敏感服务暴露。同时，控制敏感服务出站流量。VPC是在云中预配置出一个逻辑隔离的环境，不要选用经典网络等各租户互通的网络环境，预防阿里云租户之前的经典网络内网攻击路线。数字钱包服务端系统，使用Iptables等保护系统相互隔离，控制资源仅可信域连接。

- 日志审计

搜集和保存数字钱包服务端各种日志，便于服务状态监控，故障排查，被渗透后的溯源追踪等。日志保存时间至少6个月以上。

- 冗余安全

对数字钱包核心系统进行冗余配置，保证服务的高可用。定期进行系统快照，核心数据备份等。检测数字钱包账户下EBS(区块存储)，RDS(云数据库)，AMI(主机镜像)等所有快照和备份服务，严格保证其为私密权限，防止意外暴露。

- 云IAM授权检测

如使用云IAM，因为IAM是云上对用户权限，资源权限控制的一种服务，检测数字钱包使用过程中的配置安全问题。妥善保管凭证，合理分配权限。

#### 服务端应用安全检测

　- 代码安全

数字钱包APP代码和服务端代码,上线前进行进行安全审核，检查通过后，允许上线。每次改动代码后，也要进行安全复查，同时定期进行黑灰盒扫描测试。另外对代码进行严格控制，防止上传到Github等第三方代码托管平台。

- 服务应用安全

数字钱包服务端应用上线前，先进行安全加固，运行时保持低权限运行，同时定期监控，黑白盒扫描漏洞。

- 存储安全

服务器端如果需要存储敏感信息，必须使用强加密算法加密敏感信息后再存入到数据库，否则在出现数据库数据被泄露的情况下导致敏感信息泄露。检测敏感信息在存入数据库之前是否采用强加密算法加密敏感信息。

- 环境隔离

数字钱包不同功能的服务，建议模块化运行，保持相互独立且隔离，防止越权访问和读取数据，减轻被攻击后的横向渗透。

- 云存储

数字钱包如使用类似Amazon S3的对象存储服务时，严格控制权限问题，防止未授权可读写造成一系列安全问题。


## 三、总结

## 四、参考

- [http://www.cebnet.com.cn/20180614/102499338.html](http://www.cebnet.com.cn/20180614/102499338.html)