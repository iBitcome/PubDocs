--- 


title: 加密数字货币钱包安全建议

author: bobby


---

一个钱包是不是安全主要看它能否安全的管理和使用私钥。

# 前言

2017年是加密数字货币的爆发之年——比特币涨幅近13倍，很多人认为，加密数字货币是金融行业中最大的革命力量之一。

毋庸置疑的是，比特币的崛起和上涨，引发了全球对加密数字货币未来前景的关注和期待。2018年，加密数字货币将有希望迎来重大转折。在当下加密货币的发展探索中，安全是最为关键的一环，是决定其健康可持续发展的基石。因此，打造安全可靠的数字货币钱包作为数字资产的存储地是至关重要的。

基于加密数字钱包业务类型和移动应用APP的安全经验和认知，详细解读数字货币钱包目前存在的主要安全漏洞问题，对数字货币钱包用户提出安全性建议。

# 加密数字货币钱包的概念和用途

## 加密数字货币钱包是什么？

加密数字货币是一种基于区块链技术的数字货币，加密数字货币钱包是专门用来管理这些资产的应用。

加密数字货币钱包提供钱包地址的创建、加密数字货币转账、每个钱包地址交易历史的查询等基础金融功能。

钱包应用按照密码学原理创建1个或多个钱包地址，每个钱包地址都对应1个密钥对：私钥和公钥。

公钥是根据私钥进行一定的数学运算生成，与私钥一一对应。公钥主要是对外交易使用，每次交易都必须使用私钥对交易记录进行签名以证明对相关钱包地址里面的资产有控制权。

私钥是唯一能够证明对于数字资产有控制权的凭证，因此对于数字资产钱包来说，私钥是最重要的。私钥的生成和存储方式决定了资产安全与否。

因此，通常意义上的数字资产安全其实就是私钥的安全，一个钱包是不是安全主要看它能否安全的管理和使用私钥。助记词是明文私钥的另一种表现形式，其目的是为了帮助用户记忆复杂的私钥。因此能否安全的管理助记词也是区别钱包是否安全的重要条件。

## 加密数字货币钱包有哪些功能？

加密数字货币钱包是用于管理和使用私钥的工具，有了私钥就可以拥有相应地址上的加密数字货币的支配权。

- 加密数字货币钱包最基本的功能包括：

- 私钥的生成和管理

- 助记词的生成和管理

- 钱包地址的生成

- 支持导入其他钱包生成的私钥和助记词

- 对数字资产进行转账等

# 技术上的安全问题

一个安全的加密数字货币钱包，在安全技术上需要进行全方面的考核和设计，避免私钥/助记词被盗窃或丢失。安全的数字钱包应该至少从4个维度来进行设计：

（1） 运行环境的安全风险

加密数字货币钱包最核心的文件—私钥/助记词是存储在终端设备上的，无论是PC端还是移动端，终端设备如果出现不安全的现象，对于私钥/助记词来说是有非常高的安全风险的。

一个安全的数字钱包，在设计之初就避免因为运行环境而导致的私钥/助记词存在被盗可能。

终端上运行环境的安全问题主要包括病毒软件、操作系统漏洞和硬件漏洞。

- 病毒软件

和普通的银行客户端或支付手段不同的是，加密数字货币钱包的私钥/助记词不具备挂失能力，无法通过对账户进行冻结来降低损失，一旦被盗资产一定会丢失。

一款安全的数字钱包，能否对扫描出的终端环境里面的病毒软件和未知病毒软件进行防御是核心考核指标之一。

- 操作系统漏洞

利用操作系统漏洞，可以轻易的绕过操作系统设计的一系列安全边界或沙箱机制，获得访问加密数字货币钱包私钥/助记词的能力。

无论是Android、iOS，每年都有大量的安全漏洞被公开和被修复，而这些漏洞里面就有不少本地提权的漏洞。利用这些提权漏洞就可以轻易的打破操作系统的安全设计边界，获得访问用户数字钱包私钥/助记词的能力。

目前大多数加密数字货币钱包的安全设计都是完全依靠操作系统的安全边界，对于私钥/助记词的存储和处理还是停留在早期的使用固定密钥进行加密甚至直接明文保存，完全依靠操作系统的安全边界来限制其他APP的访问，由于缺乏对于系统漏洞的防御，这些数字钱包的用户如果安装了带有本地提权机制的应用，那么其数字资产将面临严重的被盗风险。

- 硬件漏洞

以CPU漏洞Meltdown（熔断）和Spectre（幽灵）为例，利用CPU架构设计上的瑕疵，可以直接通过CPU在处理机密信息时留下的Cache内容，读取到用户的私钥/助记词内容。

（2） 网络传输的安全风险

网络传输的安全性更多的体现在是否有良好的对抗中间人攻击的能力上。中间人攻击（英语：Man-in-the-middle attack，缩写：MITM）是指攻击者与通讯的两端分别创建独立的联系，并交换其所收到的数据，使通讯的两端认为他们正在通过一个私密的连接与对方直接对话，但事实上整个会话都被攻击者完全控制。

虽然大部分数字钱包应用都会使用HTTPS协议和服务端进行通讯，但是中间人攻击方法上是可以通过在用户终端中安装一个数字证书的方式拿到HTTPS协议里面的内容。

安全的数字钱包需要能够对终端里面全部的数字证书的合法性进行扫描、对网络传输过程中的代理设置进行检查并能够保障基础的网络通讯环境的安全性。

在数字钱包的开发中，在网络传输层面是否使用双向校验的方式进行通讯验证也是衡量一个数字钱包应用安全性的重要评判标准。

（3） 文件存储方式的安全风险

对于数字钱包的私钥/助记词，终端设备的存储方式也是需要在安全性设计上加以注意的。私钥/助记词文件存放目录的访问权限、私钥/助记词存储的形式和加密算法设计都需要通过严密设计。

在对多款主流数字钱包进行安全性分析时，我们发现即使是知名的数字钱包，在私钥/助记词的存储上也是比较随意的。既有明文存储的，也有虽然是加密存储但是解密的密钥却是在代码里面固定写死的，起不到任何的安全防御作用。

（4）应用自身的安全风险

应用自身的安全风险主要集中在应用安装包自身的安全防御上。

应用安装包是否具备抗篡改能力是非常核心的技术能力。另外，应用运行过程中的内存安全、反调试能力、私钥/助记词使用的生命周期管理、调试日志的安全性、开发流程的安全等方面也是需要去设计增强的。

（5）数据备份的安全风险

如果移动应用能够被备份出来，就可以使用计算性能更加强大的机器对私钥/助记词进行暴力破解。举例来说，如果android:allowBackup 属性设置为允许备份，那么就可以利用系统的备份机制对应用的数据文件进行备份，而加密数字货币的私钥/助记词也就被备份到外部介质了，这就从另外一个方向打破了操作系统的安全边界设计。

# 加密数字货币钱包应遵循的安全建议

安全是加密数字货币钱包最根基的内容。一个安全的加密数字货币钱包应该能在任何时候都让用户私钥/助记词处于安全保护之下。

在此原则下，结合加密数字钱包的业务场景和业界的优秀实践以及APP通用安全，加密数字货币钱包的设计应遵循以下安全体系：基础安全、密钥管理安全、业务安全、开发流程安全。


## 基础安全
**注意：**
**对于钱包来讲，本质上还是一个android和IOS的APP应用，APP通用基础的安全请遵循：**

- **[Android应用软件通用安全设计.md](../app/android/Android应用软件通用安全设计.md)**

- **[Android通用安全编程规范.md](../app/android/Android通用安全编程规范.md)**

- **[IOS应用软件通用安全设计.md](../app/IOS/IOS应用软件通用安全设计.md)**

- **[IOS通用安全编程规范.md](../app/IOS/IOS通用安全编程规范.md)**



### 存储安全

在本地存储数据时，是否会将敏感信息保存在本地，如果一些对用户敏感的信息保存在本地，容易被攻击者进行逆向分析。

- 采用安全的加密算法例如AES，3DES等加密本地保存的敏感数据，并且能够CBC模式的必须采用CBC模式，禁止ECB模式。
- 密钥和向量需要隐藏，不能硬编码在java或者objectiv-c中，因为这两种语言是比较容易被反编译的。
- 尽量把加解密算法写入到so库， 并且在编译so的时候对源码进行混淆或者插入花指令。
- 如果有可能，采用安全公司的密钥白盒SDK生成加解密密钥。


### 网络安全

在数据网络交互通信中，如果采用http协议明文传输的方式，将会导致敏感信息被泄漏、中间人攻击，黑客将数据替换，导致用户在APP上收到虚假信息、链路被劫持等风险。

- 使用https，并且对证书和域名做严格的校验。
- 检测链路是否存在使用相关代理的情况。
- 重要敏感数据采用二次加密的方式，必须采用业务证明的安全的加密算法和妥善保存密钥。
- 通信协议加密SDK，可以通过对开发者预提交的https通信证书，进行校验和锁定，屏蔽各种第三方中间人注入工具（例如fiddler、burp等），防止https通信数据被拦截、窃听和修改，极大的保护了https通信中的协议安全。


### 内存安全

钱包APP未对于手机环境进行root/越狱、模拟器检测，会导致APP运行在已root/越狱、模拟器的手机上，使得APP相关核心执行过程被逆向调试分析。

- 钱包APP需要做root/越狱、模拟器环境检查，如果检测到运行环境已经root/越狱、模拟器，APP提示用户并且强制退出。

钱包APP未对于手机当前系统版本进行检测并做出相关判断，将导致已知漏洞对手机系统的损害，使得钱包APP容易被黑客控制权限。

- 如果有必要做此项检测，需要使用安全公司的清场SDK来检测APP的运行环境是否安全。

钱包的账户管理（包括新建钱包、备份、导入钱包、存储钱包）属于钱包的核心算法，为了提高钱包的安全性，建议采取如下措施：

- 核心算法的源代码采取源码混淆的方式来提高源码被反编译的难度；
- 整体采用加固技术来对抗钱包app被反编译。

### 安装包安全

钱包APP未做完整性检测，会导致黑客可以对APP重新打包植入恶意代码，窃取用户助记词，私钥等敏感信息，我们将进行模拟攻击，对APP进行重打包，修改验证机制来判定是否可利用此漏洞。

- APP对自身代码做完整性校验，并且采用安全的签名打包机制。


## 密钥管理安全


### 私钥生成与存储的安全

#### 私钥生成、导出安全

钱包APP在新用户私钥生成过程，相关算法如果可被逆向分析，会导致黑客模拟生成的私钥，使用户的钱财受到损失。

- 采用业界成熟的标准库使用椭圆曲线算法生成公私钥，在区块链中的相关技术中，椭圆曲线采用secp256k1。
- 私钥长度满足相关协议要求规定。
- 私钥导出页面必须有防止界面截屏和录屏功能。
- 禁止任何私自记录私钥的行为，包括log日志、临时文件等。

#### 私钥储存安全

私钥生成后，如果会在本地保存，在本地保存时是明文存储，将会导致黑客进行攻击获取用户私钥信息。如果是加密存储，加密算法安全性不高，将会导致黑客可以逆向分析算法，将加密数据进行恢复明文，导致用户私钥信息泄露。

- 掌握了私钥，就相当于掌握了用户的钱包。因此钱包本地不直接存储用户的私钥。

### 助记词生成与存储的安全 


#### 助记词创建安全

新用户使用钱包APP时，会生成助记词要求用户记录，此过程是否有检测截屏，录屏等操作，如未进行安全检测，将会导致钱包核心敏感信息泄露，用户钱财损失。

- 助记词产生是否完全随机化，或者采用业界成熟的标准库生成助记词。
- 涉及助记词页面是否有防止界面被截屏或者录屏。
- 禁止任何私自记录助记词的行为，包括log日志、临时文件等。

#### 助记词存储安全

助记词生成后，如果会在本地保存，在本地保存时是明文存储，将会导致黑客进行攻击获取用户助记词信息。如果是加密存储，加密算法安全性不高，将会导致黑客可以逆向分析算法，将加密数据进行恢复明文，导致用户助记词信息泄露。

- 原则上不会存储助记词。
- 但是在助记词用户没有备份之前：

  * 需要提醒用户及时备份。
  * 助记词持久性的加密存储在终端上面。加密算法采用业界安全的对称加密算法例如AES、3DES等。
  * 密钥使用用户创建钱包时候的输入密码。
  * 整个加密算法最好写入到so库，因此CBC模式下需要iv向量，并且so库在混淆编译后反编译的难度大于java代码的反编译难度。
- 用户备份助记词之前需要校验授权密码，在用户备份助记词以后，钱包本地必须删除助记词的相关所有信息。

### Keystore生成与存储的安全

#### keystore生成、导出安全

keystore文件的生成过程，相关算法是否可以被逆向分析。

- keystore文件采用业界成熟的标准库生成keystore文件。
- keystore文件导出页面必须有防止界面截屏和录屏功能。
- 禁止任何私自记录keystore文件的行为，包括log日志、临时文件等。

#### keystone存储安全

keystore文件存储在本地，在本地保存时是明文存储，将会导致黑客进行攻击获取用户私钥信息。如果是加密存储，加密算法安全性不高，将会导致黑客恶意破解加密数据。如果keystore文件存储在公共存储区域，将会导致被恶意app删除keystore文件文件。

- keystore文件本地加密存储，具体的存储方式请参考[存储安全](#存储安全)章节。
- keystore文件尽量存储在私有沙箱目录下，例如每个APP特有的/data/data/appname/目录下。不要存储到公共的存储区域例如外部storage目录，因为只要其他恶意的app申请了storage的权限就可以对存储在此目录下的keystore文件做操作。

### 钱包口令生成、修改与存储的安全

#### 钱包口令生成、修改安全

交易密码如果未检测弱口令，将会导致黑客对密码进行猜解，直接进行交易。修改口令之前没有验证旧口令，将会导致口令被恶意修改。

- 在输入口令的时候必须检测口令是否符合相关密码复杂度要求。例如是否满足一定的长度和数字、大小写字母、特殊符号组成。
- 输入口令页面必须有防止界面截屏和录屏功能。
- 禁止任何私自记录口令的行为，包括log日志、临时文件等。
- 修改旧口令之前必须验证新口令，如果验证失败必须回退到业务初始状态。

#### 钱包口令存储安全

钱包口令本地存储，本地储存加密不严格，则会导致黑客对其进行逆向分析，获取到钱包口令。

- 钱包本地不存储钱包口令， 并且在创建钱包时提醒用户妥善保存钱包口令。 

### 导入钱包安全

导入钱包目前三种方式：

#### keystore文件+授权密码

通过导入keystore文件和授权密码方式来导入钱包，需要注意的是：

- 在这个过程中任何文件例如包括log日志、临时文件等记录授权密码和私钥。
- 导入的keystore文件的保存安全措施和新建钱包一样，参考[Keystore生成与存储的安全](#Keystore生成与存储的安全)

#### 助记词+新的授权密码

通过助记词和新的授权密码来导入钱包，内部实现的流程和新建钱包流程类似，需要注意的是：

- 在这个过程中任何文件例如包括log日志、临时文件等记录授权密码和助记词。
- 通过这种方式生成的keystore文件的保存安全措施和新建钱包一样，参考[Keystore生成与存储的安全](#Keystore生成与存储的安全)


#### 私钥+新的授权密码

通过私钥和新的授权密码来导入钱包，内部实现的流程和新建钱包流程类似，需要注意的是：

- 在这个过程中任何文件例如包括log日志、临时文件等记录授权密码和私钥。
- 通过这种方式生成的keystore文件的保存安全措施和新建钱包一样，参考[Keystore生成与存储的安全](#Keystore生成与存储的安全)

## 业务安全

### 创建交易安全

在用户创建交易时，交易双方的账号如果没有二次验证，则容易导致收款账户信息被恶意替换后无法知道，导致用户钱财损失问题。

- 填写交易信息后，在发送交易之前需要有最终确认的过程来保证交易双方地址和金额是否正确。
- 交易失败后，需要回滚到交易之前到初始状态。

### 交易签名安全

在交易创建后，发送正式签名交易过程，如果相关协议设计不严格，会导致用户财产受到损失。

- 严格要求相关协议要求设计交易签名信息和其他信息。

### 交易完毕确认

交易完毕后，如果未对交易内容进行确认，会导致使用户清晰了解此次交易过程的记录，在APP上无法记录相关信息，无法查询个人交易记录，我们会对此过程进行分析。

- 必须提供交易完成确认功能。

### 余额查询安全

钱包APP在进行余额查询时，无论是从货币官方服务器，还是钱包厂商服务器进行的查询，应严格对其返回给客户端的数据进行完整性验证，否则容意导致用户APP数据接收虚假、异常信息。

- 提供余额查询功能。
- 余额信息进行完整性校验。

## 开发流程安全

### 代码安全

- 数字钱包APP代码上线前进行进行安全审核，检查通过后，允许上线。每次改动代码后，也要进行安全复查，同时定期进行黑灰盒扫描测试。另外对代码进行严格控制，防止上传到Github等第三方代码托管平台。

# 参考


- [猎豹移动发布：2018全球加密数字货币钱包安全白皮书](http://www.cmcmbc.com/zh-cn/blog/research/2018-04-18/79.html)
- [360:数字货币钱包安全白皮书](http://www.cebnet.com.cn/20180614/102499338.html)







